---
title: Praca Pagamento
author: Bruno
date: '2019-07-09'
slug: praca-pagamento
categories:
  - R
tags:
  - teste
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(geosphere) #carrega pacote para calculo dist
raio = 25*1000
options(scipen=10)
```

# Dados

```{r limpagem}
dados = read.csv2(file = "C:\\Users/Bruno Ferrari/Documents/2019/Estagio/dist_job/mai2_estudo.csv", na.strings="", stringsAsFactors = F) #leitura dos dados

dados[dados == 0 ] = NA #limpagem dos dados, ponhe NA onde estava valor 0 lat e 0 long
dados$VALOR_PAGO_TITULO[is.na(dados$VALOR_PAGO_TITULO)] = 0
dados$PRACA_PGMTO = 0
dados$VOP = 0
df_VOP = matrix(ncol = 6)
df_VOP = data.frame(df_VOP)
names(df_VOP) = c("Ind?cio", "Pra?a", "Total", "Indicio_5%", "Pra?a_5%", "Total_5%")

vop_na = matrix(ncol = 3)
vop_na = data.frame(vop_na)
names(vop_na) = c("VOP D?spon?vel", "VOP N?o Dispon?vel", "Total")


for(i in 1:nrow(dados)){
  #m = dados$M?S_REFERENCIA[i]
  id = dados$ID_CEDENTE[i]
  dados$VOP[i] = sum(dados$VALOR_PAGO_TITULO[dados$ID_CEDENTE==id])
}

dados_org = dados

dados[1, ]
```

# Regras

- Regra 1: Local Liquida??o do T?tulo = Local Cedente Sede
- Regra 2: Local Liquida??o do T?tulo = Local Cedente Cobran?a
- Regra 3 e 4: Chegagem Negativa e Qnt Boleto
- Regra 5: Local Liquida??o do T?tulo <> Local Sacado

# Regra 1

Vari?veis envolvidas:

```{r var 1}
names(dados)[c(6,7,38,39,26,31)]
```


```{r}
x = table(is.na(dados$LATITUDE_CEDENTE_SEDE) | is.na(dados$LONGITUDE_CEDENTE_SEDE))
names(x) = c("Com Lat-Long", "Sem Lat-Long")
x
100*x/sum(x)
pie(x, main = "Local Cedente Sede")

```

```{r}
x = table(is.na(dados$LATITUDE_PAGAMENTO_TITULO) | is.na(dados$LONGITUDE_PAGAMENTO_TITULO))
names(x) = c("Com Lat-Long", "Sem Lat-Long")
x
100*x/sum(x)
pie(x, main = "Local Liquida??o T?tulo")
```

```{r}
ind = is.na(dados[ , 6]) | is.na(dados[ , 7]) |is.na(dados[ , 38]) |is.na(dados[ , 39])
x = table(is.na(dados[ , 6]) | is.na(dados[ , 7]) |is.na(dados[ , 38]) |is.na(dados[ , 39]))
names(x) = c("Com Lat-Long", "Sem Lat-Long")
x
100*x/sum(x)
pie(x, main = "Total V?lido")
val = x[1]
```

Valor Operado
```{r}
ind = is.na(dados[ , 6]) | is.na(dados[ , 7]) |is.na(dados[ , 38]) |is.na(dados[ , 39])
vop_na[1, 3] = sum(dados$VALOR_PAGO_TITULO)
vop_na[1, 2] = sum(dados$VALOR_PAGO_TITULO[ind])
vop_na[1, 1] = vop_na[1,3] - vop_na[1,2]

vop_na[2, ] = (vop_na[1, ]/vop_na[1,3])*100

vop_na
pie(as.numeric(vop_na[1, 1:2]), main = "VOP", labels = names(vop_na)[1:2])
```



Aplicando a Regra:
```{r regra 1}
for (i in 1:nrow(dados)) {
  d = distm(dados[i,c(7,6)], dados[i,c(39,38)], fun = distHaversine)
  
  if(!(is.na(d)) & d <= raio){
    if ((!is.na(dados$TIPO_CHECAGEM[i]) & dados$TIPO_CHECAGEM[i] == "Negativa") | 
                                      (dados$QUANTIDADE_EMISSAO_SEGUNDA_VIA_BOLETO_TITULO[i] >= 1 &                                            !is.na(dados$QUANTIDADE_EMISSAO_SEGUNDA_VIA_BOLETO_TITULO[i]))){
      dados$PRACA_PGMTO[i] = 2
    }
    else{
      if(dados$PRACA_PGMTO[i] == 0)
        dados$PRACA_PGMTO[i] = 1
    }
  } 
}

dados$PRACA_PGMTO_1 = dados$PRACA_PGMTO

x = table(dados$PRACA_PGMTO)
x
print("Porcentagem Total")
(sum(x[2:3])/sum(x))*100
print("Porcentagem Dados V?lidos")
(sum(x[2:3])/val)*100



for (i in 1:nrow(dados)) {
  if(dados$VALOR_PAGO_TITULO[i]/dados$VOP[i] < 0.05 | dados$VALOR_PAGO_TITULO[i] == 0)
    {dados$PRACA_PGMTO[i] = 0}
}

dados$PRACA_PGMTO_1F = dados$PRACA_PGMTO

x = table(dados$PRACA_PGMTO)
x
print("Porcentagem Total")
(sum(x[2:3])/sum(x))*100
print("Porcentagem Dados V?lidos")
(sum(x[2:3])/val)*100
```

Valor Operado
```{r}
df_VOP[1, 1] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_1 == 1])
df_VOP[1, 2] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_1 == 2])
df_VOP[1, 3] = sum(df_VOP[1, 1:2])

df_VOP[1, 4] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_1F == 1])
df_VOP[1, 5] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_1F == 2])
df_VOP[1, 6] = sum(df_VOP[1, 4:5])

df_VOP[1, ]

#for (i in names(table(dados$ID_CEDENTE))) {
  
#}
```

# Regra 2

Vari?veis envolvidas:
```{r var 2}
names(dados)[c(11,12,38,39)]
```

```{r}
x = table(is.na(dados$LATITUDE_CEDENTE_COBRANCA) | is.na(dados$LONGITUDE_CEDENTE_COBRANCA))
names(x) = c("Com Lat-Long", "Sem Lat-Long")
x
100*x/sum(x)
pie(x, main = "Local Cedente Sede")

```

```{r}
x = table(is.na(dados[ , 11]) | is.na(dados[ , 12]) |is.na(dados[ , 38]) |is.na(dados[ , 39]))
names(x) = c("Com Lat-Long", "Sem Lat-Long")
x
100*x/sum(x)
pie(x, main = "Total V?lido")
val = x[1]
```


Valor Operado
```{r}
ind = is.na(dados[ , 11]) | is.na(dados[ , 12]) |is.na(dados[ , 38]) |is.na(dados[ , 39])
vop_na[1, 3] = sum(dados$VALOR_PAGO_TITULO)
vop_na[1, 2] = sum(dados$VALOR_PAGO_TITULO[ind])
vop_na[1, 1] = vop_na[1,3] - vop_na[1,2]

vop_na[2, ] = (vop_na[1, ]/vop_na[1,3])*100

vop_na
pie(as.numeric(vop_na[1, 1:2]), main = "VOP", labels = names(vop_na)[1:2])
```

```{r regra 2}
dados$PRACA_PGMTO = dados_org$PRACA_PGMTO

for (i in 1:nrow(dados)) {
  d = distm(dados[i,c(12, 11)], dados[i,c(39, 38)], fun =  distHaversine)
  
  if(!(is.na(d)) & d <= raio){
    dados$PRACA_PGMTO[i] = 2
    }
}

dados$PRACA_PGMTO_2 = dados$PRACA_PGMTO

x = table(dados$PRACA_PGMTO)
x
print("Porcentagem Total")
(sum(x[2])/sum(x))*100
print("Porcentagem Dados V?lidos")
(sum(x[2])/val)*100


for (i in 1:nrow(dados)) {
  if(dados$VALOR_PAGO_TITULO[i]/dados$VOP[i] < 0.05 | dados$VALOR_PAGO_TITULO[i] == 0)
    {dados$PRACA_PGMTO[i] = 0}
}

dados$PRACA_PGMTO_2F = dados$PRACA_PGMTO

x = table(dados$PRACA_PGMTO)
x
print("Porcentagem Total")
(sum(x[2])/sum(x))*100
print("Porcentagem Dados V?lidos")
(sum(x[2])/val)*100

```

Valor Operado
```{r}
df_VOP[2, 1] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_2 == 1])
df_VOP[2, 2] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_2 == 2])
df_VOP[2, 3] = sum(df_VOP[2, 1:2])

df_VOP[2, 4] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_2F == 1])
df_VOP[2, 5] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_2F == 2])
df_VOP[2, 6] = sum(df_VOP[2, 4:5])

df_VOP[2, ]

#for (i in names(table(dados$ID_CEDENTE))) {
  
#}
```

# Regra 3 e 4


Nesta regra h? duas variav?is poss?veis candidatas para a "Pra?a Sacado", o Local Sacado Sede, e o Local Sacado Cobran?a
```{r var 3 e 4}
names(dados)[c(17,18,22,23,38,39,26,31)]
```

Fazendo uma an?lise das duas v?ri?veis, vamos ver que
```{r}
x = table(is.na(dados$LATITUDE_SACADO_SEDE) | is.na(dados$LONGITUDE_SACADO_SEDE))
names(x) = c("Com Lat-Long", "Sem Lat-Long")
x
100*x/sum(x)
pie(x, main = "Local Sacado Sede")
```

```{r}
x = table(is.na(dados$LATITUDE_SACADO_COBRANCA) | is.na(dados$LONGITUDE_SACADO_COBRANCA))
names(x) = c("Com Lat-Long", "Sem Lat-Long")
x
100*x/sum(x)
pie(x, main = "Local Sacado Cobran?a")
```

A base de dados para o Local Sacado Sede est? muito desfalcada, enquanto o Local Sacado Cobran?a est? quase toda dispon?vel, logo vamos utilizar como "Pra?a Sacado" a segunda v?ri?vel.

```{r}
x = table(is.na(dados[ , 22]) | is.na(dados[ , 23]) |is.na(dados[ , 38]) |is.na(dados[ , 39]))
names(x) = c("Com Lat-Long", "Sem Lat-Long")
x
100*x/sum(x)
pie(x, main = "Total V?lido")
val = x[1]
```

Valor Operado
```{r}
ind = (is.na(dados[ , 22]) | is.na(dados[ , 23]) |is.na(dados[ , 38]) | is.na(dados[ , 39])) |
      (is.na(dados$TIPO_CHECAGEM) & is.na(dados$QUANTIDADE_EMISSAO_SEGUNDA_VIA_BOLETO_TITULO))
vop_na[1, 3] = sum(dados$VALOR_PAGO_TITULO)
vop_na[1, 2] = sum(dados$VALOR_PAGO_TITULO[ind])
vop_na[1, 1] = vop_na[1,3] - vop_na[1,2]

vop_na[2, ] = (vop_na[1, ]/vop_na[1,3])*100

vop_na
pie(as.numeric(vop_na[1, 1:2]), main = "VOP", labels = names(vop_na)[1:2])
```


Aplicando a Regra:

```{r regra 3 4}
dados$PRACA_PGMTO = dados_org$PRACA_PGMTO

for (i in 1:nrow(dados)) {
  d = distm(dados[i,c(23,22)], dados[i,c(39,38)], fun =  distHaversine)
  
  if ((!is.na(dados$TIPO_CHECAGEM[i]) & dados$TIPO_CHECAGEM[i] == "Negativa") &
                                                (dados$QUANTIDADE_EMISSAO_SEGUNDA_VIA_BOLETO_TITULO[i] >= 1 & 
                                                !is.na(dados$QUANTIDADE_EMISSAO_SEGUNDA_VIA_BOLETO_TITULO[i]))){
      dados$PRACA_PGMTO[i] = 2
    }
    else if ((!(is.na(d)) & d > raio) & (!is.na(dados$TIPO_CHECAGEM[i]) & dados$TIPO_CHECAGEM[i] == "Negativa")){
      if(dados$PRACA_PGMTO[i] == 0)
        dados$PRACA_PGMTO[i] = 1
    }
    else if ((!(is.na(d)) & d > raio) & (dados$QUANTIDADE_EMISSAO_SEGUNDA_VIA_BOLETO_TITULO[i] >= 1 & 
                                        !is.na(dados$QUANTIDADE_EMISSAO_SEGUNDA_VIA_BOLETO_TITULO[i]))){
      if(dados$PRACA_PGMTO[i] == 0)
        dados$PRACA_PGMTO[i] = 1
    }
}

dados$PRACA_PGMTO_34 = dados$PRACA_PGMTO

x = table(dados$PRACA_PGMTO)
x
print("Porcentagem Total")
(sum(x[2:3])/sum(x))*100
print("Porcentagem Dados V?lidos")
(sum(x[2:3])/val)*100


for (i in 1:nrow(dados)) {
  if(dados$VALOR_PAGO_TITULO[i]/dados$VOP[i] < 0.05 | dados$VALOR_PAGO_TITULO[i] == 0)
    {dados$PRACA_PGMTO[i] = 0}
}

dados$PRACA_PGMTO_34F = dados$PRACA_PGMTO

x = table(dados$PRACA_PGMTO)
x
print("Porcentagem Total")
(sum(x[2:3])/sum(x))*100
print("Porcentagem Dados V?lidos")
(sum(x[2:3])/val)*100

```

Valor Operado
```{r}
df_VOP[3, 1] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_34 == 1])
df_VOP[3, 2] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_34 == 2])
df_VOP[3, 3] = sum(df_VOP[3, 1:2])

df_VOP[3, 4] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_34F == 1])
df_VOP[3, 5] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_34F == 2])
df_VOP[3, 6] = sum(df_VOP[3, 4:5])

df_VOP[3, ]

#for (i in names(table(dados$ID_CEDENTE))) {
  
#}
```

# Regra 5

Vari?veis envolvidas:
```{r var 5}
names(dados)[c(22,23,38,39,26,31)]
```

Aplicando a Regra:
```{r regra 5}
dados$PRACA_PGMTO = dados_org$PRACA_PGMTO

for (i in 1:nrow(dados)) {
  d = distm(dados[i,c(23,22)], dados[i,c(39,38)], fun =  distHaversine)
  
  if(!(is.na(d)) & d > raio){
    if ((!is.na(dados$TIPO_CHECAGEM[i]) & dados$TIPO_CHECAGEM[i] == "Negativa") | 
                                                (dados$QUANTIDADE_EMISSAO_SEGUNDA_VIA_BOLETO_TITULO[i] >= 1 & 
                                                !is.na(dados$QUANTIDADE_EMISSAO_SEGUNDA_VIA_BOLETO_TITULO[i]))){
      dados$PRACA_PGMTO[i] = 2
    }
    else{
      if(dados$PRACA_PGMTO[i] == 0)
        dados$PRACA_PGMTO[i] = 1
    }
  } 
}

dados$PRACA_PGMTO_5 = dados$PRACA_PGMTO

x = table(dados$PRACA_PGMTO)
x
print("Porcentagem Total")
(sum(x[2:3])/sum(x))*100
print("Porcentagem Dados V?lidos")
(sum(x[2:3])/val)*100


for (i in 1:nrow(dados)) {
  if(dados$VALOR_PAGO_TITULO[i]/dados$VOP[i] < 0.05 | dados$VALOR_PAGO_TITULO[i] == 0)
    {dados$PRACA_PGMTO[i] = 0}
}

dados$PRACA_PGMTO_5F = dados$PRACA_PGMTO

x = table(dados$PRACA_PGMTO)
x
print("Porcentagem Total")
(sum(x[2:3])/sum(x))*100
print("Porcentagem Dados V?lidos")
(sum(x[2:3])/val)*100

```

Valor Operado
```{r}
df_VOP[4, 1] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_5 == 1])
df_VOP[4, 2] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_5 == 2])
df_VOP[4, 3] = sum(df_VOP[4, 1:2])

df_VOP[4, 4] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_5F == 1])
df_VOP[4, 5] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_5F == 2])
df_VOP[4, 6] = sum(df_VOP[4, 4:5])

df_VOP[4, ]

#for (i in names(table(dados$ID_CEDENTE))) {
  
#}
```

# Total

```{r}
ind = (is.na(dados[ , 6]) & is.na(dados[ , 11]) & is.na( dados[ , 22] )) | is.na(dados[ , 38])

x = table(ind)
names(x) = c("Com Lat-Long", "Sem Lat-Long")
x
100*x/sum(x)
pie(x, main = "Total V?lido")
val = x[1]
```

Valor Operado
```{r}
vop_na[1, 3] = sum(dados$VALOR_PAGO_TITULO)
vop_na[1, 2] = sum(dados$VALOR_PAGO_TITULO[ind])
vop_na[1, 1] = vop_na[1,3] - vop_na[1,2]

vop_na[2, ] = (vop_na[1, ]/vop_na[1,3])*100

vop_na
pie(as.numeric(vop_na[1, 1:2]), main = "VOP", labels = names(vop_na)[1:2])
```

```{r}
x = 0
xf = 0

for (i in 1:nrow(dados)) {
  
  x[i] = max(dados[i, c(56,58,60,62)+4])
  xf[i] = max(dados[i, c(56,58,60,62) + 1 + 4])
}

dados$PRACA_PGMTO = x
dados$PRACA_PGMTO_F = xf

x = table(dados$PRACA_PGMTO)
x
print("Porcentagem Total")
(sum(x[2:3])/sum(x))*100
print("Porcentagem Dados V?lidos")
(sum(x[2:3])/val)*100

x = table(dados$PRACA_PGMTO_F)
x
print("Porcentagem Total")
(sum(x[2:3])/sum(x))*100
print("Porcentagem Dados V?lidos")
(sum(x[2:3])/val)*100

write.csv2(dados, file = "PRACA_MAI2.csv")
```

Valor Operado
```{r}
df_VOP[5, 1] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO == 1])
df_VOP[5, 2] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO == 2])
df_VOP[5, 3] = sum(df_VOP[5, 1:2])

df_VOP[5, 4] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_F == 1])
df_VOP[5, 5] = sum(dados$VALOR_PAGO_TITULO[dados$PRACA_PGMTO_F == 2])
df_VOP[5, 6] = sum(df_VOP[5, 4:5])

df_VOP

#for (i in names(table(dados$ID_CEDENTE))) {
  
#}
```